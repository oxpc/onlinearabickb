<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Virtual Arabic Keyboard - 101 Layout with Special Diacritics">
  <title>Arabic Virtual Keyboard | ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</title>
  
  <style>
    /* --- Global Styles --- */
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg-color: #f1f5f9;
      --text-main: #0f172a;
      --surface: #ffffff;
      --border: #cbd5e1;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 950px;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      box-sizing: border-box;
    }

    header { text-align: center; }
    header h1 { margin: 0; color: var(--primary); font-size: 2rem; }
    header p { margin-top: 0.5rem; color: #64748b; }

    /* --- Editor Area --- */
    .editor {
      background: var(--surface);
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      border: 1px solid var(--border);
    }

    .toolbar {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }

    button.tool-btn {
      background: transparent;
      border: 1px solid #94a3b8;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-main);
      font-family: inherit;
    }

    button.tool-btn:hover {
      background-color: #f8fafc;
      border-color: var(--primary);
      color: var(--primary);
    }

    button.tool-btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    button.tool-btn.primary:hover {
      background: var(--primary-hover);
    }

    textarea {
      width: 100%;
      min-height: 150px;
      border: none;
      resize: vertical;
      font-size: 2rem; 
      font-family: 'Times New Roman', serif;
      direction: rtl;
      padding: 0.5rem;
      box-sizing: border-box;
      outline: none;
      color: #000;
      line-height: 1.6;
    }

    footer {
      margin-top: auto;
      padding: 2rem;
      color: #64748b;
      font-size: 0.9rem;
      text-align: center;
    }
    footer a { color: var(--primary); text-decoration: none; }
  </style>
</head>

<body>

  <div class="container">
    <header>
      <h1>ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</h1>
      <p>Type with mouse or physical keyboard</p>
    </header>

    <div class="editor">
      <div class="toolbar">
        <button id="clearBtn" class="tool-btn" title="Clear Text">
          <span>ŸÖÿ≥ÿ≠ (Clear)</span> üóëÔ∏è
        </button>
        <button id="copyBtn" class="tool-btn primary" title="Copy to Clipboard">
          <span>ŸÜÿ≥ÿÆ (Copy)</span> üìã
        </button>
      </div>
      
      <textarea id="screen" dir="rtl" placeholder="ÿ£ŸÉÿ™ÿ® ŸáŸÜÿß... (Type here)"></textarea>
    </div>

    <!-- The Web Component -->
    <arabic-keyboard id="kb"></arabic-keyboard>
  </div>

  <footer>
    <p>Open Source Project. <a href="https://github.com/oxpc/onlinearabickb">View on GitHub</a></p>
  </footer>

  <!-- 
    WEB COMPONENT LOGIC 
  -->
  <script type="module">
    import { LitElement, html, css } from 'https://esm.sh/lit@3.1.2';

    // Helper to define Diacritic Map
    const DIACRITICS = [
      { id: 'fat', ar: 'Ÿé', label: 'a =',  base: 'a' },
      { id: 'tan', ar: 'Ÿã', label: 'an =', base: 'an' }, // requires logic to detect 'an' sequence or just assume 'shift+w'
      { id: 'dam', ar: 'Ÿè', label: 'u =',  base: 'u' },
      { id: 'dun', ar: 'Ÿå', label: 'un =', base: 'un' },
      { id: 'kas', ar: 'Ÿê', label: 'i =',  base: 'i' },
      { id: 'kin', ar: 'Ÿç', label: 'in =', base: 'in' },
      { id: 'sha', ar: 'Ÿë', label: 's =',  base: 's' },
      { id: 'suk', ar: 'Ÿí', label: 'h =',  base: 'h' }
    ];

    const KEY_ROWS = [
      // ROW 1
      [
        { code: 'Backquote', ar: 'ÿ∞', en: '`', shift: 'Ÿë' },
        { code: 'Digit1', ar: '1', en: '1', shift: '!' },
        { code: 'Digit2', ar: '2', en: '2', shift: '@' },
        { code: 'Digit3', ar: '3', en: '3', shift: '#' },
        { code: 'Digit4', ar: '4', en: '4', shift: '$' },
        { code: 'Digit5', ar: '5', en: '5', shift: '%' },
        { code: 'Digit6', ar: '6', en: '6', shift: '^' },
        { code: 'Digit7', ar: '7', en: '7', shift: '&' },
        { code: 'Digit8', ar: '8', en: '8', shift: '*' },
        { code: 'Digit9', ar: '9', en: '9', shift: ')' },
        { code: 'Digit0', ar: '0', en: '0', shift: '(' },
        { code: 'Minus', ar: '-', en: '-', shift: '_' },
        { code: 'Equal', ar: '=', en: '=', shift: '+' },
        { code: 'Backspace', label: 'Backspace', type: 'action', width: 'backspace' }
      ],
      // ROW 2
      [
        { code: 'Tab', label: 'Tab', type: 'action', width: 'tab' },
        { code: 'KeyQ', ar: 'ÿ∂', en: 'q', shift: 'Ÿé' },
        { code: 'KeyW', ar: 'ÿµ', en: 'w', shift: 'Ÿã' },
        { code: 'KeyE', ar: 'ÿ´', en: 'e', shift: 'Ÿè' },
        { code: 'KeyR', ar: 'ŸÇ', en: 'r', shift: 'Ÿå' },
        { code: 'KeyT', ar: 'ŸÅ', en: 't', shift: 'ŸÑÿ•' },
        { code: 'KeyY', ar: 'ÿ∫', en: 'y', shift: 'ÿ•' },
        { code: 'KeyU', ar: 'ÿπ', en: 'u', shift: '‚Äò' },
        { code: 'KeyI', ar: 'Ÿá', en: 'i', shift: '√∑' },
        { code: 'KeyO', ar: 'ÿÆ', en: 'o', shift: '√ó' },
        { code: 'KeyP', ar: 'ÿ≠', en: 'p', shift: 'ÿõ' },
        { code: 'BracketLeft', ar: 'ÿ¨', en: '[', shift: '<' },
        { code: 'BracketRight', ar: 'ÿØ', en: ']', shift: '>' },
        { code: 'Backslash', ar: '\\', en: '\\', shift: '|' }
      ],
      // ROW 3
      [
        { code: 'CapsLock', label: 'CapLk', type: 'action', width: 'caps' },
        { code: 'KeyA', ar: 'ÿ¥', en: 'a', shift: 'Ÿê' },
        { code: 'KeyS', ar: 'ÿ≥', en: 's', shift: 'Ÿç' },
        { code: 'KeyD', ar: 'Ÿä', en: 'd', shift: ']' },
        { code: 'KeyF', ar: 'ÿ®', en: 'f', shift: '[' },
        { code: 'KeyG', ar: 'ŸÑ', en: 'g', shift: 'ŸÑÿ£' },
        { code: 'KeyH', ar: 'ÿß', en: 'h', shift: 'ÿ£' },
        { code: 'KeyJ', ar: 'ÿ™', en: 'j', shift: 'ŸÄ' },
        { code: 'KeyK', ar: 'ŸÜ', en: 'k', shift: 'ÿå' },
        { code: 'KeyL', ar: 'ŸÖ', en: 'l', shift: '/' },
        { code: 'Semicolon', ar: 'ŸÉ', en: ';', shift: ':' },
        { code: 'Quote', ar: 'ÿ∑', en: "'", shift: '"' },
        { code: 'Enter', label: 'Enter', type: 'action', width: 'enter' }
      ],
      // ROW 4
      [
        { code: 'ShiftLeft', label: 'Shift', type: 'action', width: 'shift' },
        { code: 'KeyZ', ar: 'ÿ¶', en: 'z', shift: '~' },
        { code: 'KeyX', ar: 'ÿ°', en: 'x', shift: 'Ÿí' },
        { code: 'KeyC', ar: 'ÿ§', en: 'c', shift: '}' },
        { code: 'KeyV', ar: 'ÿ±', en: 'v', shift: '{' },
        { code: 'KeyB', ar: 'ŸÑÿß', en: 'b', shift: 'ŸÑÿ¢' },
        { code: 'KeyN', ar: 'Ÿâ', en: 'n', shift: 'ÿ¢' },
        { code: 'KeyM', ar: 'ÿ©', en: 'm', shift: '‚Äô' },
        { code: 'Comma', ar: 'Ÿà', en: ',', shift: ',' },
        { code: 'Period', ar: 'ÿ≤', en: '.', shift: '.' },
        { code: 'Slash', ar: 'ÿ∏', en: '/', shift: 'ÿü' },
        { code: 'ShiftRight', label: 'Shift', type: 'action', width: 'shift' }
      ],
      // ROW 5 - Special Diacritics Row (Virtual keys)
      [
        ...DIACRITICS.map(d => ({ code: `Virtual_${d.id}`, ar: d.ar, en: d.label, type: 'char' }))
      ],
      // ROW 6
      [
        { code: 'MetaLeft', label: 'Meta', type: 'action', width: 'meta' },
        { code: 'Space', ar: ' ', label: 'Space', type: 'char', width: 'spacebar' },
        { code: 'Sound', label: 'üîä', type: 'action', width: 'meta', action: 'toggleSound' }
      ]
    ];

    export class ArabicKeyboard extends LitElement {
      static properties = {
        _shiftActive: { state: true },
        _capsActive: { state: true }
      };

      static styles = css`
        :host {
          display: block;
          background-color: #eee;
          padding: 8px;
          border-radius: 4px;
          user-select: none;
          direction: ltr; 
          border: 1px solid #ccc;
        }

        .keyboard {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .row {
          display: flex;
          gap: 4px;
          justify-content: center;
        }

        button {
          position: relative;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: linear-gradient(to bottom, #f9f9f9 0%, #e8e8e8 100%);
          border: 1px solid #999;
          border-radius: 4px;
          min-width: 48px;
          height: 52px;
          cursor: pointer;
          padding: 0;
          box-shadow: 0 1px 1px rgba(0,0,0,0.1);
          font-family: inherit;
          -webkit-tap-highlight-color: transparent;
        }

        button:active, button.pressed {
          background: #dcdcdc;
          transform: translateY(1px);
        }

        button.active {
          background: #d4e4ff;
          border-color: #2563eb;
        }

        .txt-en {
          position: absolute;
          top: 3px;
          left: 5px;
          font-size: 11px; /* Slightly smaller to fit "an=" */
          color: #0000ff; 
          font-weight: normal;
        }

        .txt-shift {
          position: absolute;
          top: 3px;
          right: 5px;
          font-size: 13px;
          color: #ff0000;
        }

        .txt-ar {
          font-size: 1.4rem;
          color: #000000; 
          font-weight: bold;
          margin-top: 12px;
          line-height: 1;
        }

        .key-label {
          font-weight: bold;
          font-size: 14px;
          color: #000;
        }

        .backspace { width: 100px; }
        .tab { width: 70px; }
        .caps { width: 80px; }
        .enter { width: 110px; }
        .shift { width: 130px; }
        .meta { width: 90px; }
        .spacebar { flex-grow: 1; max-width: 600px; }

        @media (max-width: 800px) {
          button { min-width: 36px; height: 45px; }
          .txt-en, .txt-shift { font-size: 9px; }
          .txt-ar { font-size: 1.1rem; margin-top: 8px; }
          .backspace, .tab, .caps, .enter, .shift, .meta { width: auto; flex-grow: 1; font-size: 11px; }
        }
      `;

      constructor() {
        super();
        this._shiftActive = false;
        this._capsActive = false;
        this._keyMap = new Map();
        // Tracks previous key for the special a+= logic
        this._lastPhysicalKey = null; 

        KEY_ROWS.flat().forEach(k => {
          if (k.code && !k.code.startsWith('Virtual')) {
            this._keyMap.set(k.code, k);
          }
        });

        this._boundKeyDown = this._onPhysicalKeyDown.bind(this);
        this._boundKeyUp = this._onPhysicalKeyUp.bind(this);
      }

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('keydown', this._boundKeyDown);
        window.addEventListener('keyup', this._boundKeyUp);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        window.removeEventListener('keydown', this._boundKeyDown);
        window.removeEventListener('keyup', this._boundKeyUp);
      }

      _onPhysicalKeyDown(e) {
        const active = document.activeElement;
        const isScreen = active && active.id === 'screen';
        
        if (e.ctrlKey || e.metaKey || e.altKey) return;

        // Logic for "Letter + Equal" shortcuts logic
        // If user pressed '=', check previous key
        if (isScreen && e.key === '=' && this._lastPhysicalKey) {
          const map = {
            'a': 'Ÿé',  // Fatha
            'u': 'Ÿè',  // Damma
            'i': 'Ÿê',  // Kasra
            's': 'Ÿë',  // Shadda
            'h': 'Ÿí',  // Sukun
            // Special handling for 'an', 'un', 'in' relies on last char typed
            // but physical keydown is simpler to map 1:1. 
            // For complex 'an=', we assume 'a' then '=' for simple case, 
            // or specific keys if they exist.
            // Implementing basic single char mapping:
          };
          
          // Check for Tanween sequences roughly (requires tracking input history really)
          // For now, let's stick to the Standard Arabic 101 Mapping provided in KEY_ROWS
          // because browser sends KeyCodes.
        }

        const keyData = this._keyMap.get(e.code);
        if (keyData) {
          if (isScreen) e.preventDefault(); 
          this._handleInput(keyData);
          
          const btn = this.shadowRoot.querySelector(`button[data-code="${e.code}"]`);
          if (btn) btn.classList.add('pressed');
          
          // Track last key for potential combo logic if needed later
          this._lastPhysicalKey = e.key; 
        } else if (e.key === 'Shift') {
           this._shiftActive = true;
        }
      }

      _onPhysicalKeyUp(e) {
        const btn = this.shadowRoot.querySelector(`button[data-code="${e.code}"]`);
        if (btn) btn.classList.remove('pressed');
        if (e.key === 'Shift') this._shiftActive = false;
      }

      _handleInput(key) {
        let char = key.ar;
        let action = null;

        if (key.type === 'action') {
          if (key.code === 'Backspace') action = 'delete';
          else if (key.code === 'Enter') action = 'enter';
          else if (key.code === 'Tab') action = 'tab';
          else if (key.code && key.code.includes('Shift')) {
            this._shiftActive = !this._shiftActive; 
            return;
          }
          else if (key.code === 'CapsLock') {
            this._capsActive = !this._capsActive;
            return;
          }
        } else {
          // It is a char key
          if (this._shiftActive && key.shift) {
            char = key.shift;
            if (!this._capsActive) { 
               // Standard typing behavior
            }
          }
        }

        this.dispatchEvent(new CustomEvent('kb-input', {
          detail: { char: action ? null : char, action },
          bubbles: true,
          composed: true
        }));
      }

      render() {
        return html`
          <div class="keyboard">
            ${KEY_ROWS.map(row => html`
              <div class="row">
                ${row.map(key => this._renderKey(key))}
              </div>
            `)}
          </div>
        `;
      }

      _renderKey(key) {
        const isShift = key.code && key.code.includes('Shift');
        const isCaps = key.code === 'CapsLock';
        const isActive = (isShift && this._shiftActive) || (isCaps && this._capsActive);
        
        let content;
        if (key.type === 'action' || key.label) {
          content = html`<span class="key-label">${key.label || key.ar}</span>`;
        } else {
          // Virtual Keys (Row 5) or Standard Keys
          content = html`
            ${key.en ? html`<span class="txt-en">${key.en}</span>` : ''}
            ${key.shift ? html`<span class="txt-shift">${key.shift}</span>` : ''}
            <span class="txt-ar">${this._shiftActive && key.shift ? key.shift : key.ar}</span>
          `;
        }

        return html`
          <button 
            data-code="${key.code}"
            class="${key.width || ''} ${isActive ? 'active' : ''}" 
            @click="${(e) => { 
              e.preventDefault(); 
              document.getElementById('screen')?.focus();
              this._handleInput(key); 
            }}"
          >
            ${content}
          </button>
        `;
      }
    }

    customElements.define('arabic-keyboard', ArabicKeyboard);
  </script>

  <!-- APP LOGIC -->
  <script>
    const textarea = document.getElementById('screen');
    const kb = document.getElementById('kb');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');

    // Handle Input
    kb.addEventListener('kb-input', (e) => {
      const { char, action } = e.detail;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      
      textarea.focus();

      if (action === 'delete') {
        if (start === end && start > 0) {
          textarea.setRangeText('', start - 1, end, 'end');
        } else {
          textarea.setRangeText('', start, end, 'end');
        }
      } else if (action === 'enter') {
        textarea.setRangeText('\n', start, end, 'end');
      } else if (action === 'tab') {
        textarea.setRangeText('\t', start, end, 'end');
      } else if (char) {
        textarea.setRangeText(char, start, end, 'end');
      }
    });

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(textarea.value);
        const original = copyBtn.innerText;
        copyBtn.innerText = 'Copied!';
        setTimeout(() => copyBtn.innerText = original, 1000);
      } catch (err) {}
    });

    clearBtn.addEventListener('click', () => {
      textarea.value = '';
      textarea.focus();
    });
  </script>
</body>
</html>
