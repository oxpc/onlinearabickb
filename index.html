<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Virtual Arabic Keyboard - Standard 101 Layout">
  <title>Arabic Virtual Keyboard | ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</title>
  
  <style>
    /* --- Global Styles --- */
    :root {
      --bg-color: #f3f3f3;
      --key-bg: #f5f5f5;
      --key-border: #b5b5b5;
      --key-active: #e2e2e2;
      
      /* Colors from the image */
      --color-en: #0000ff; /* Blue */
      --color-shift: #ff0000; /* Red */
      --color-ar: #000000; /* Black */
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-sizing: border-box;
    }

    /* --- Editor Area --- */
    textarea {
      width: 100%;
      min-height: 120px;
      border: 1px solid #999;
      border-radius: 4px;
      font-size: 1.8rem;
      font-family: 'Times New Roman', serif;
      direction: rtl;
      padding: 10px;
      box-sizing: border-box;
      background: white;
      resize: vertical;
    }

    textarea:focus {
      outline: 2px solid #66afe9;
    }

    .controls {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    button.btn {
      padding: 5px 15px;
      cursor: pointer;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-weight: bold;
    }
    
    button.btn:hover { background: #ddd; }

    footer {
      margin-top: auto;
      padding: 1rem;
      font-size: 0.8rem;
      color: #666;
      text-align: center;
    }
    footer a { color: #333; }
  </style>
</head>

<body>

  <div class="container">
    <div class="controls">
      <button class="btn" id="copyBtn">Copy Text</button>
      <button class="btn" id="clearBtn">Clear</button>
    </div>
    
    <textarea id="screen" dir="rtl" placeholder="Write here..."></textarea>

    <!-- The Web Component -->
    <arabic-keyboard id="kb"></arabic-keyboard>
  </div>

  <footer>
    <p>Arabic 101 Layout Implementation.</p>
  </footer>

  <!-- WEB COMPONENT LOGIC -->
  <script type="module">
    import { LitElement, html, css } from 'https://esm.sh/lit@3.1.2';

    // Data matching the specific image layout
    const KEY_ROWS = [
      // ROW 1
      [
        { code: 'Backquote', ar: 'ÿ∞', en: '`', shift: 'Ÿë' }, // Shadda on shift
        { code: 'Digit1', ar: '1', en: '1', shift: '!' },
        { code: 'Digit2', ar: '2', en: '2', shift: '@' },
        { code: 'Digit3', ar: '3', en: '3', shift: '#' },
        { code: 'Digit4', ar: '4', en: '4', shift: '$' },
        { code: 'Digit5', ar: '5', en: '5', shift: '%' },
        { code: 'Digit6', ar: '6', en: '6', shift: '^' },
        { code: 'Digit7', ar: '7', en: '7', shift: '&' },
        { code: 'Digit8', ar: '8', en: '8', shift: '*' },
        { code: 'Digit9', ar: '9', en: '9', shift: ')' },
        { code: 'Digit0', ar: '0', en: '0', shift: '(' },
        { code: 'Minus', ar: '-', en: '-', shift: '_' },
        { code: 'Equal', ar: '=', en: '=', shift: '+' },
        { code: 'Backspace', label: 'Backspace', type: 'action', width: 'backspace' }
      ],
      // ROW 2
      [
        { code: 'Tab', label: 'Tab', type: 'action', width: 'tab' },
        { code: 'KeyQ', ar: 'ÿ∂', en: 'q', shift: 'Ÿé' }, // Fatha
        { code: 'KeyW', ar: 'ÿµ', en: 'w', shift: 'Ÿã' }, // Fathatain
        { code: 'KeyE', ar: 'ÿ´', en: 'e', shift: 'Ÿè' }, // Damma
        { code: 'KeyR', ar: 'ŸÇ', en: 'r', shift: 'Ÿå' }, // Dammatain
        { code: 'KeyT', ar: 'ŸÅ', en: 't', shift: 'ŸÑÿ•' },
        { code: 'KeyY', ar: 'ÿ∫', en: 'y', shift: 'ÿ•' },
        { code: 'KeyU', ar: 'ÿπ', en: 'u', shift: '‚Äò' },
        { code: 'KeyI', ar: 'Ÿá', en: 'i', shift: '√∑' },
        { code: 'KeyO', ar: 'ÿÆ', en: 'o', shift: '√ó' },
        { code: 'KeyP', ar: 'ÿ≠', en: 'p', shift: 'ÿõ' },
        { code: 'BracketLeft', ar: 'ÿ¨', en: '[', shift: '<' }, // Usually < is on comma, but mapped to key for display
        { code: 'BracketRight', ar: 'ÿØ', en: ']', shift: '>' },
        { code: 'Backslash', ar: '\\', en: '\\', shift: '|' }
      ],
      // ROW 3
      [
        { code: 'CapsLock', label: 'CapLk', type: 'action', width: 'caps' },
        { code: 'KeyA', ar: 'ÿ¥', en: 'a', shift: 'Ÿê' }, // Kasra
        { code: 'KeyS', ar: 'ÿ≥', en: 's', shift: 'Ÿç' }, // Kasratain
        { code: 'KeyD', ar: 'Ÿä', en: 'd', shift: ']' },
        { code: 'KeyF', ar: 'ÿ®', en: 'f', shift: '[' },
        { code: 'KeyG', ar: 'ŸÑ', en: 'g', shift: 'ŸÑÿ£' },
        { code: 'KeyH', ar: 'ÿß', en: 'h', shift: 'ÿ£' },
        { code: 'KeyJ', ar: 'ÿ™', en: 'j', shift: 'ŸÄ' },
        { code: 'KeyK', ar: 'ŸÜ', en: 'k', shift: 'ÿå' },
        { code: 'KeyL', ar: 'ŸÖ', en: 'l', shift: '/' },
        { code: 'Semicolon', ar: 'ŸÉ', en: ';', shift: ':' },
        { code: 'Quote', ar: 'ÿ∑', en: "'", shift: '"' },
        { code: 'Enter', label: 'Enter', type: 'action', width: 'enter' }
      ],
      // ROW 4
      [
        { code: 'ShiftLeft', label: 'Shift', type: 'action', width: 'shift' },
        { code: 'KeyZ', ar: 'ÿ¶', en: 'z', shift: '~' },
        { code: 'KeyX', ar: 'ÿ°', en: 'x', shift: 'Ÿí' }, // Sukun
        { code: 'KeyC', ar: 'ÿ§', en: 'c', shift: '}' },
        { code: 'KeyV', ar: 'ÿ±', en: 'v', shift: '{' },
        { code: 'KeyB', ar: 'ŸÑÿß', en: 'b', shift: 'ŸÑÿ¢' },
        { code: 'KeyN', ar: 'Ÿâ', en: 'n', shift: 'ÿ¢' },
        { code: 'KeyM', ar: 'ÿ©', en: 'm', shift: '‚Äô' },
        { code: 'Comma', ar: 'Ÿà', en: ',', shift: ',' },
        { code: 'Period', ar: 'ÿ≤', en: '.', shift: '.' },
        { code: 'Slash', ar: 'ÿ∏', en: '/', shift: 'ÿü' },
        { code: 'ShiftRight', label: 'Shift', type: 'action', width: 'shift' }
      ],
      // ROW 5 - Diacritics Row (Matches the image's row above space)
      // These act as "Virtual Keys" for Harakat that are normally Shift+[Key] on physical
      [
        { code: 'Virtual_Fatha', ar: 'Ÿé', en: 'a=', type: 'char' },
        { code: 'Virtual_Fathatain', ar: 'Ÿã', en: 'an=', type: 'char' },
        { code: 'Virtual_Damma', ar: 'Ÿè', en: 'u=', type: 'char' },
        { code: 'Virtual_Dammatain', ar: 'Ÿå', en: 'un=', type: 'char' },
        { code: 'Virtual_Kasra', ar: 'Ÿê', en: 'i=', type: 'char' },
        { code: 'Virtual_Kasratain', ar: 'Ÿç', en: 'in=', type: 'char' },
        { code: 'Virtual_Sukun', ar: 'Ÿí', en: 'h=', type: 'char' },
        { code: 'Virtual_Shadda', ar: 'Ÿë', en: 's=', type: 'char' },
        { code: 'Virtual_Madd', ar: 'Ÿâ', en: 'y--', shift: 'Ÿ∞', type: 'char' }, // Aproximation for image
        { code: 'Virtual_Waw', ar: 'ÿ§', en: 'w--', type: 'char' },
        { code: 'Virtual_Alef', ar: 'ÿ•', en: 'a--', type: 'char' }
      ],
      // ROW 6 - Space/Meta
      [
        { code: 'MetaLeft', label: 'Meta', type: 'action', width: 'meta' },
        { code: 'Space', ar: ' ', label: 'Space', type: 'char', width: 'spacebar' },
        { code: 'Sound', label: 'üîä', type: 'action', width: 'meta', action: 'toggleSound' }
      ]
    ];

    export class ArabicKeyboard extends LitElement {
      static properties = {
        _shiftActive: { state: true },
        _capsActive: { state: true }
      };

      static styles = css`
        :host {
          display: block;
          background-color: #eee;
          padding: 8px;
          border-radius: 4px;
          user-select: none;
          direction: ltr; /* Layout is LTR */
          border: 1px solid #ccc;
        }

        .keyboard {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .row {
          display: flex;
          gap: 4px;
          justify-content: center;
        }

        /* Key Styles matching the image */
        button {
          position: relative;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: linear-gradient(to bottom, #f9f9f9 0%, #e8e8e8 100%);
          border: 1px solid #999;
          border-radius: 4px;
          min-width: 45px;
          height: 48px;
          cursor: pointer;
          padding: 0;
          box-shadow: 0 1px 1px rgba(0,0,0,0.1);
          font-family: inherit;
        }

        button:active, button.pressed {
          background: #dcdcdc;
          transform: translateY(1px);
        }

        button.active {
          background: #d4e4ff;
          border-color: #2563eb;
        }

        /* Colors from Image */
        .txt-en {
          position: absolute;
          top: 2px;
          left: 4px;
          font-size: 14px;
          color: #0000ff; /* Blue */
          font-weight: normal;
        }

        .txt-shift {
          position: absolute;
          top: 2px;
          right: 4px;
          font-size: 14px;
          color: #ff0000; /* Red */
        }

        .txt-ar {
          font-size: 1.25rem;
          color: #000000; /* Black */
          font-weight: bold;
          margin-top: 10px; /* Push down slightly */
        }

        /* Special Keys (Tab, Shift, etc) */
        .key-label {
          font-weight: bold;
          font-size: 16px;
          color: #000;
        }

        /* Widths */
        .backspace { width: 100px; }
        .tab { width: 70px; }
        .caps { width: 80px; }
        .enter { width: 110px; }
        .shift { width: 130px; }
        .meta { width: 90px; }
        .spacebar { flex-grow: 1; max-width: 600px; }

        @media (max-width: 700px) {
          button { min-width: 32px; height: 40px; }
          .txt-en, .txt-shift { font-size: 10px; }
          .txt-ar { font-size: 1rem; margin-top: 5px; }
          .backspace, .tab, .caps, .enter, .shift, .meta { width: auto; flex-grow: 1; font-size: 12px; }
        }
      `;

      constructor() {
        super();
        this._shiftActive = false;
        this._capsActive = false;
        this._keyMap = new Map();

        // Map physical keys to data
        KEY_ROWS.flat().forEach(k => {
          if (k.code && !k.code.startsWith('Virtual')) {
            this._keyMap.set(k.code, k);
          }
        });

        this._boundKeyDown = this._onPhysicalKeyDown.bind(this);
        this._boundKeyUp = this._onPhysicalKeyUp.bind(this);
      }

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('keydown', this._boundKeyDown);
        window.addEventListener('keyup', this._boundKeyUp);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        window.removeEventListener('keydown', this._boundKeyDown);
        window.removeEventListener('keyup', this._boundKeyUp);
      }

      _onPhysicalKeyDown(e) {
        const active = document.activeElement;
        const isScreen = active && active.id === 'screen';
        
        // Prevent default only if typing in textarea or if it's a character key
        // Allow shortcuts
        if (e.ctrlKey || e.metaKey || e.altKey) return;

        const keyData = this._keyMap.get(e.code);
        if (keyData) {
          if (isScreen) e.preventDefault(); // Stop English input
          this._handleInput(keyData);
          
          const btn = this.shadowRoot.querySelector(`button[data-code="${e.code}"]`);
          if (btn) btn.classList.add('pressed');
        } else if (e.key === 'Shift') {
           this._shiftActive = true;
        }
      }

      _onPhysicalKeyUp(e) {
        const btn = this.shadowRoot.querySelector(`button[data-code="${e.code}"]`);
        if (btn) btn.classList.remove('pressed');
        
        if (e.key === 'Shift') {
           this._shiftActive = false;
        }
      }

      _handleInput(key) {
        let char = key.ar;
        let action = null;

        if (key.type === 'action') {
          if (key.code === 'Backspace') action = 'delete';
          else if (key.code === 'Enter') action = 'enter';
          else if (key.code === 'Tab') action = 'tab';
          else if (key.code.includes('Shift')) {
            this._shiftActive = !this._shiftActive; // Toggle for virtual click
            return;
          }
          else if (key.code === 'CapsLock') {
            this._capsActive = !this._capsActive;
            return;
          }
        } else {
          // It is a char key
          if (this._shiftActive && key.shift) {
            char = key.shift;
            // Virtual shift behavior: usually releases after one char unless caps
            if (!this._capsActive) { 
                // We typically don't auto-disable shift on physical hold, 
                // but for virtual click we might. Keeping it simple.
            }
          }
        }

        this.dispatchEvent(new CustomEvent('kb-input', {
          detail: { char: action ? null : char, action },
          bubbles: true,
          composed: true
        }));
      }

      render() {
        return html`
          <div class="keyboard">
            ${KEY_ROWS.map(row => html`
              <div class="row">
                ${row.map(key => this._renderKey(key))}
              </div>
            `)}
          </div>
        `;
      }

      _renderKey(key) {
        const isShift = key.code && key.code.includes('Shift');
        const isCaps = key.code === 'CapsLock';
        const isActive = (isShift && this._shiftActive) || (isCaps && this._capsActive);
        
        // Render content based on key type
        let content;
        if (key.type === 'action' || key.label) {
          content = html`<span class="key-label">${key.label || key.ar}</span>`;
        } else {
          // Standard layout: English Top-Left, Shift Top-Right, Arabic Center
          content = html`
            ${key.en ? html`<span class="txt-en">${key.en}</span>` : ''}
            ${key.shift ? html`<span class="txt-shift">${key.shift}</span>` : ''}
            <span class="txt-ar">${this._shiftActive && key.shift ? key.shift : key.ar}</span>
          `;
        }

        return html`
          <button 
            data-code="${key.code}"
            class="${key.width || ''} ${isActive ? 'active' : ''}" 
            @click="${(e) => { 
              e.preventDefault(); 
              // Keep focus on textarea
              const screen = document.getElementById('screen');
              if(screen) screen.focus();
              this._handleInput(key); 
            }}"
          >
            ${content}
          </button>
        `;
      }
    }

    customElements.define('arabic-keyboard', ArabicKeyboard);
  </script>

  <!-- APP LOGIC -->
  <script>
    const textarea = document.getElementById('screen');
    const kb = document.getElementById('kb');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');

    // Handle Virtual & Physical input
    kb.addEventListener('kb-input', (e) => {
      const { char, action } = e.detail;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      
      textarea.focus();

      if (action === 'delete') {
        if (start === end && start > 0) {
          textarea.setRangeText('', start - 1, end, 'end');
        } else {
          textarea.setRangeText('', start, end, 'end');
        }
      } else if (action === 'enter') {
        textarea.setRangeText('\n', start, end, 'end');
      } else if (action === 'tab') {
        textarea.setRangeText('\t', start, end, 'end');
      } else if (char) {
        textarea.setRangeText(char, start, end, 'end');
      }
    });

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(textarea.value);
        const original = copyBtn.innerText;
        copyBtn.innerText = 'Copied!';
        setTimeout(() => copyBtn.innerText = original, 1000);
      } catch (err) {}
    });

    clearBtn.addEventListener('click', () => {
      textarea.value = '';
      textarea.focus();
    });
  </script>
</body>
</html>
